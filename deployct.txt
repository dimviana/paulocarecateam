#!/bin/bash
# ==============================================================================
#           Unified Deployment Manager for SAAS Applications
# ==============================================================================
#
# This script automates the installation, update, and removal of multiple
# applications on the same server, each with its own domains and ports.
# It uses Nginx to serve static frontend files and as a reverse proxy
# for the backend.
#
# SYSTEMS MANAGED:
#   1. Gerencia Boleto (Dois Domínios)
#   2. Jiu-Jitsu Hub (Domínio Único com Proxy Reverso)
#
# PRE-REQUISITES:
#   - A Linux VPS (tested on Debian/Ubuntu).
#   - The backend for each application must be started separately (e.g., with PM2).
#   - The database for each application must be configured manually.
#   - NOTE: This script clones repositories using public HTTPS URLs. This will
#     fail for private repositories as the script is non-interactive. For
#     private repos, use SSH keys and adjust the repository URLs accordingly.
#
# USAGE:
#   1. Place this script in any directory (e.g., /tmp/deploy.sh).
#   2. Grant execution permissions: chmod +x deploy.sh
#   3. Run the script: ./deploy.sh
#   4. Follow the interactive menu prompts.
#
# ==============================================================================

# --- Global Settings ---
# Color codes for output
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
RED='\033[0;31m'
NC='\033[0m' # No Color
ADMIN_EMAIL="androiddiviana@gmail.com" # Common email for Certbot registration

# ==============================================================================
#               <<< APPLICATION CONFIGURATIONS >>>
#     EDIT THE VARIABLES IN THE SECTIONS BELOW FOR EACH APPLICATION
# ==============================================================================

# --- Configurações: Gerencia Boleto (Arquitetura de Dois Domínios) ---
GB_APP_NAME="Gerencia Boleto"
GB_FRONTEND_DOMAIN="boleto.abildeveloper.com.br"
GB_BACKEND_DOMAIN="boletobk.abildeveloper.com.br" # Domínio separado para o backend
GB_REPO_URL="https://github.com/dimviana/gerencia-boleto.git"
GB_APP_DIR="/home/abildeveloper-gerenciaboleto/htdocs/boleto.abildeveloper.com.br"
GB_BUILD_DIR="dist"
GB_BACKEND_PORT=3000
GB_FRONTEND_NGINX_PORT=80
GB_BACKEND_NGINX_PORT=80 # Porta de escuta do Nginx para o backend
GB_PM2_PROCESS_NAME="gerencia-boleto-backend"

# --- Configurações: Jiu-Jitsu Hub (Arquitetura de Domínio Único) ---
JJH_APP_NAME="Jiu-Jitsu Hub"
JJH_DOMAIN="paulocarecateam.abildeveloper.com.br" # Domínio único para frontend e backend
JJH_REPO_URL="https://github.com/dimviana/paulocarecateam.git"
JJH_APP_DIR="/home/abildeveloper-paulocarecateam/htdocs/paulocarecateam.abildeveloper.com.br"
JJH_BUILD_DIR="dist"
JJH_BACKEND_PORT=3001
JJH_NGINX_PORT=80 # Porta única para o Nginx
JJH_PM2_PROCESS_NAME="jiujitsu-hub-backend"

# ==============================================================================
#                     <<< CORE LOGIC FUNCTIONS >>>
#         (Generally, no need to edit below this line)
# ==============================================================================

# --- Helper Functions ---
check_command() {
    command -v $1 >/dev/null 2>&1
}

# --- Generic Functions ---

install_dependencies() {
    echo -e "\n${YELLOW}[ STEP 1/5 ] Verificando e instalando dependências do sistema...${NC}"
    
    if check_command nginx && check_command node && check_command pm2 && check_command certbot; then
        echo -e "${GREEN}-> Todas as dependências principais (Nginx, Node.js, PM2, Certbot) já estão instaladas.${NC}"
        return
    fi
    
    sudo apt-get update -y
    sudo apt-get install -y curl git software-properties-common

    if ! check_command node || [[ $(node -v | cut -d . -f 1) < "v18" ]]; then
        echo "-> Configurando o repositório do Node.js v18..."
        curl -fsSL https://deb.nodesource.com/setup_18.x | sudo -E bash -
    fi

    echo "-> Instalando Nginx, Node.js, Certbot..."
    sudo apt-get install -y nginx nodejs certbot python3-certbot-nginx
    if [ $? -ne 0 ]; then
        echo -e "${RED}ERRO: Falha ao instalar dependências. Tente executar 'sudo apt-get -f install' e rode o script novamente.${NC}"
        exit 1
    fi

    if ! check_command pm2; then
        echo "-> Instalando PM2 globalmente via npm..."
        sudo npm install -g pm2
    fi

    echo -e "${GREEN}-> Dependências instaladas com sucesso.${NC}"
}

setup_source_code() {
    local APP_DIR="$1"
    local REPO_URL="$2"
    echo -e "\n${YELLOW}[ STEP 2/5 ] Baixando o código fonte...${NC}"

    if [ -d "$APP_DIR/.git" ]; then
        echo -e "${YELLOW}AVISO: O repositório já existe em '$APP_DIR'. Pulando o clone.${NC}"
        return
    fi

    sudo mkdir -p "$(dirname "$APP_DIR")"
    sudo chown -R $(whoami):$(whoami) "$(dirname "$APP_DIR")"

    GIT_TERMINAL_PROMPT=0 git clone "$REPO_URL" "$APP_DIR"
    if [ $? -ne 0 ]; then
        echo -e "${RED}ERRO: Falha ao clonar o repositório. Verifique a URL e se o repositório é público.${NC}"
        exit 1
    fi
    sudo chown -R $(whoami):$(whoami) "$APP_DIR"
    echo -e "${GREEN}-> Código fonte clonado para '$APP_DIR'.${NC}"

    if [ -f "$APP_DIR/env.txt" ]; then
        echo "-> Renomeando env.txt para .env..."
        mv "$APP_DIR/env.txt" "$APP_DIR/.env"
        echo -e "${YELLOW}AVISO: O arquivo .env foi criado. Edite-o com suas credenciais de produção.${NC}"
    fi
}

build_application() {
    local APP_DIR="$1"
    local BUILD_DIR="$2"
    echo -e "\n${YELLOW}[ STEP 3/5 ] Construindo a aplicação frontend...${NC}"
    cd "$APP_DIR" || { echo -e "${RED}ERRO: Diretório '$APP_DIR' não encontrado.${NC}"; exit 1; }
    
    echo "--> Instalando dependências npm..."
    npm install
    if [ $? -ne 0 ]; then
        echo -e "${RED}ERRO: 'npm install' falhou.${NC}"
        exit 1
    fi

    echo "--> Executando o build..."
    npm run build
    if [ $? -ne 0 ]; then
        echo -e "${RED}ERRO: 'npm run build' falhou.${NC}"
        exit 1
    fi
    echo -e "${GREEN}-> Build concluído. Arquivos gerados em '$APP_DIR/$BUILD_DIR'.${NC}"
}

# --- NGINX CONFIGURATION FUNCTIONS (Specific for each architecture) ---

configure_nginx_two_domains() {
    local FRONTEND_DOMAIN="$1"
    local BACKEND_DOMAIN="$2"
    local FRONTEND_NGINX_PORT="$3"
    local BACKEND_NGINX_PORT="$4"
    local APP_DIR="$5"
    local BUILD_DIR="$6"
    local BACKEND_PORT="$7"
    
    echo -e "\n${YELLOW}[ STEP 4/5 ] Configurando Nginx e SSL (Dois Domínios)...${NC}"
    NGINX_CONF_PATH="/etc/nginx/sites-available/$FRONTEND_DOMAIN"
    
    sudo tee "$NGINX_CONF_PATH" > /dev/null <<EOF
# Configuração do Frontend: $FRONTEND_DOMAIN
server {
    listen $FRONTEND_NGINX_PORT;
    server_name $FRONTEND_DOMAIN;
    root $APP_DIR/$BUILD_DIR;
    index index.html index.htm;
    location / { try_files \$uri \$uri/ /index.html; }
}
# Configuração do Backend: $BACKEND_DOMAIN
server {
    listen $BACKEND_NGINX_PORT;
    server_name $BACKEND_DOMAIN;
    location / {
        proxy_pass http://localhost:$BACKEND_PORT;
        proxy_set_header Host \$host;
        proxy_set_header X-Real-IP \$remote_addr;
    }
}
EOF

    if [ ! -L "/etc/nginx/sites-enabled/$FRONTEND_DOMAIN" ]; then
        sudo ln -s "$NGINX_CONF_PATH" "/etc/nginx/sites-enabled/$FRONTEND_DOMAIN"
    fi

    sudo nginx -t && sudo systemctl restart nginx
    if [ $? -ne 0 ]; then echo -e "${RED}ERRO: Falha ao reiniciar o Nginx.${NC}"; exit 1; fi

    echo "-> Tentando gerar certificado SSL com Certbot..."
    sudo certbot --nginx -d "$FRONTEND_DOMAIN" -d "$BACKEND_DOMAIN" --non-interactive --agree-tos -m "$ADMIN_EMAIL" || echo -e "${YELLOW}AVISO: Falha ao gerar SSL. Acesso via HTTP.${NC}"
    
    sudo systemctl restart nginx
    echo -e "${GREEN}-> Nginx configurado.${NC}"
}

configure_nginx_single_domain() {
    local DOMAIN="$1"
    local NGINX_PORT="$2"
    local APP_DIR="$3"
    local BUILD_DIR="$4"
    local BACKEND_PORT="$5"
    
    echo -e "\n${YELLOW}[ STEP 4/5 ] Configurando Nginx e SSL (Domínio Único com Proxy Reverso)...${NC}"
    NGINX_CONF_PATH="/etc/nginx/sites-available/$DOMAIN"
    
    sudo tee "$NGINX_CONF_PATH" > /dev/null <<EOF
server {
    listen $NGINX_PORT;
    server_name $DOMAIN;

    # Bloco para a API (Proxy Reverso)
    location /api/ {
        # FIX: Removida a barra final para preservar o /api/ no proxy.
        proxy_pass http://localhost:$BACKEND_PORT;
        proxy_http_version 1.1;
        proxy_set_header Upgrade \$http_upgrade;
        proxy_set_header Connection 'upgrade';
        proxy_set_header Host \$host;
        proxy_cache_bypass \$http_upgrade;
        proxy_set_header X-Real-IP \$remote_addr;
        proxy_set_header X-Forwarded-For \$proxy_add_x_forwarded_for;
    }

    # Bloco para o Frontend (Arquivos Estáticos)
    location / {
        root $APP_DIR/$BUILD_DIR;
        try_files \$uri \$uri/ /index.html;
    }
}
EOF

    if [ ! -L "/etc/nginx/sites-enabled/$DOMAIN" ]; then
        sudo ln -s "$NGINX_CONF_PATH" "/etc/nginx/sites-enabled/$DOMAIN"
    fi

    sudo nginx -t && sudo systemctl restart nginx
    if [ $? -ne 0 ]; then echo -e "${RED}ERRO: Falha ao reiniciar o Nginx.${NC}"; exit 1; fi
    
    echo "-> Tentando gerar certificado SSL com Certbot..."
    sudo certbot --nginx -d "$DOMAIN" --non-interactive --agree-tos -m "$ADMIN_EMAIL" || echo -e "${YELLOW}AVISO: Falha ao gerar SSL. Acesso via HTTP.${NC}"

    sudo systemctl restart nginx
    echo -e "${GREEN}-> Nginx configurado.${NC}"
}

# --- FINAL MESSAGE FUNCTIONS ---

print_success_message_two_domains() {
    local FRONTEND_DOMAIN="$1"
    local BACKEND_DOMAIN="$2"
    local APP_NAME="$3"

    echo -e "\n${GREEN}========================================================"
    echo "      INSTALAÇÃO DE '$APP_NAME' CONCLUÍDA! (Dois Domínios)      "
    echo "========================================================${NC}"
    echo "Acesse o frontend em:   https://$FRONTEND_DOMAIN"
    echo "O backend está em:      https://$BACKEND_DOMAIN"
    echo ""
    echo -e "${YELLOW}AÇÃO NECESSÁRIA: O backend deve ser iniciado manualmente.${NC}"
    echo "1. Siga as instruções no INSTALL_GUIDE.md para o backend."
    echo "2. Use o guia no arquivo 'ecosystem.config.txt' para criar seu 'ecosystem.config.cjs'."
    echo "3. No diretório do backend, execute: 'pm2 start ecosystem.config.cjs'"
    echo "========================================================"
}

print_success_message_single_domain() {
    local DOMAIN="$1"
    local APP_NAME="$2"

    echo -e "\n${GREEN}========================================================"
    echo "      INSTALAÇÃO DE '$APP_NAME' CONCLUÍDA! (Domínio Único)      "
    echo "========================================================${NC}"
    echo "Acesse a aplicação em:  https://$DOMAIN"
    echo "A API está em:          https://$DOMAIN/api"
    echo ""
    echo -e "${YELLOW}AÇÃO NECESSÁRIA: O backend deve ser iniciado manually.${NC}"
    echo "1. Siga as instruções no INSTALL_GUIDE.md para o backend."
    echo "2. Use o guia no arquivo 'ecosystem.config.txt' para criar seu 'ecosystem.config.cjs'."
    echo "3. No diretório do backend, execute: 'pm2 start ecosystem.config.cjs'"
    echo "========================================================"
}


# --- Generic Workflow Functions ---

install_gb() {
    set -e
    echo -e "\n--- INICIANDO INSTALAÇÃO: $GB_APP_NAME ---"
    install_dependencies
    setup_source_code "$GB_APP_DIR" "$GB_REPO_URL"
    build_application "$GB_APP_DIR" "$GB_BUILD_DIR"
    configure_nginx_two_domains "$GB_FRONTEND_DOMAIN" "$GB_BACKEND_DOMAIN" "$GB_FRONTEND_NGINX_PORT" "$GB_BACKEND_NGINX_PORT" "$GB_APP_DIR" "$GB_BUILD_DIR" "$GB_BACKEND_PORT"
    print_success_message_two_domains "$GB_FRONTEND_DOMAIN" "$GB_BACKEND_DOMAIN" "$GB_APP_NAME"
    set +e
}

install_jjh() {
    set -e
    echo -e "\n--- INICIANDO INSTALAÇÃO: $JJH_APP_NAME ---"
    install_dependencies
    setup_source_code "$JJH_APP_DIR" "$JJH_REPO_URL"
    build_application "$JJH_APP_DIR" "$JJH_BUILD_DIR"
    configure_nginx_single_domain "$JJH_DOMAIN" "$JJH_NGINX_PORT" "$JJH_APP_DIR" "$JJH_BUILD_DIR" "$JJH_BACKEND_PORT"
    print_success_message_single_domain "$JJH_DOMAIN" "$JJH_APP_NAME"
    set +e
}

update_system() {
    local APP_DIR="$1"
    local BUILD_DIR="$2"
    local APP_NAME="$3"
    local PM2_PROCESS_NAME="$4"
    local REPO_URL="$5"

    set -e
    echo -e "\n--- INICIANDO ATUALIZAÇÃO PARA: $APP_NAME ---"
    if [ ! -d "$APP_DIR/.git" ]; then echo -e "${RED}ERRO: Diretório '$APP_DIR' não encontrado.${NC}"; exit 1; fi
    cd "$APP_DIR" || exit 1
    
    CURRENT_URL=$(git config --get remote.origin.url)
    if [[ "$CURRENT_URL" != "$REPO_URL" ]]; then
        git remote set-url origin "$REPO_URL"
    fi

    GIT_TERMINAL_PROMPT=0 git pull
    if [ $? -ne 0 ]; then echo -e "${RED}ERRO: Falha ao executar 'git pull'.${NC}"; exit 1; fi
    
    build_application "$APP_DIR" "$BUILD_DIR"
    echo -e "${GREEN}-> Frontend atualizado com sucesso!${NC}"
    echo -e "${YELLOW}AVISO: Se o backend foi atualizado, reinicie-o (ex: 'pm2 restart $PM2_PROCESS_NAME').${NC}"
    set +e
}

remove_system() {
    local DOMAIN="$1"
    local APP_DIR="$2"
    local APP_NAME="$3"
    # Adicional para o caso de dois domínios
    local SECOND_DOMAIN="${4:-}"

    echo -e "\n--- INICIANDO REMOÇÃO DE: $APP_NAME ---"
    read -p "!!! ATENÇÃO !!! Isso removerá os arquivos e configs do Nginx para '$APP_NAME'. Deseja continuar? (s/N): " confirm
    if [[ "$confirm" != "s" && "$confirm" != "S" ]]; then echo "Remoção cancelada."; return; fi

    echo "-> Removendo certificado(s) SSL..."
    sudo certbot delete --cert-name "$DOMAIN" --non-interactive 2>/dev/null || echo "Certificado para $DOMAIN não encontrado."
    if [ -n "$SECOND_DOMAIN" ]; then
        sudo certbot delete --cert-name "$SECOND_DOMAIN" --non-interactive 2>/dev/null || echo "Certificado para $SECOND_DOMAIN não encontrado."
    fi
    
    echo "-> Removendo configurações do Nginx..."
    sudo rm -f "/etc/nginx/sites-available/$DOMAIN"
    sudo rm -f "/etc/nginx/sites-enabled/$DOMAIN"
    sudo nginx -t && sudo systemctl restart nginx

    echo "-> Removendo arquivos da aplicação..."
    sudo rm -rf "$APP_DIR"
    
    echo -e "${GREEN}--- REMOÇÃO COMPLETA DE '$APP_NAME' ---${NC}"
    echo -e "${YELLOW}AVISO: O banco de dados e o processo PM2 do backend NÃO foram removidos.${NC}"
}

# --- Main Menu ---
show_main_menu() {
    while true; do
        echo -e "\n================================================="
        echo -e "      ${GREEN}Gerenciador de Implantação Unificado${NC}"
        echo "================================================="
        echo "  1) Instalar Gerencia Boleto"
        echo "  2) Instalar Jiu-Jitsu Hub"
        echo "  3) Instalar AMBOS os sistemas"
        echo
        echo "  4) Atualizar Gerencia Boleto"
        echo "  5) Atualizar Jiu-Jitsu Hub"
        echo
        echo "  6) Remover Gerencia Boleto"
        echo "  7) Remover Jiu-Jitsu Hub"
        echo "  8) Remover AMBOS os sistemas"
        echo
        echo "  9) Sair"
        echo

        read -p "Opção [1-9]: " choice

        case $choice in
            1) install_gb ;;
            2) install_jjh ;;
            3) install_gb && install_jjh ;;
            4) update_system "$GB_APP_DIR" "$GB_BUILD_DIR" "$GB_APP_NAME" "$GB_PM2_PROCESS_NAME" "$GB_REPO_URL" ;;
            5) update_system "$JJH_APP_DIR" "$JJH_BUILD_DIR" "$JJH_APP_NAME" "$JJH_PM2_PROCESS_NAME" "$JJH_REPO_URL" ;;
            6) remove_system "$GB_FRONTEND_DOMAIN" "$GB_APP_DIR" "$GB_APP_NAME" "$GB_BACKEND_DOMAIN" ;;
            7) remove_system "$JJH_DOMAIN" "$JJH_APP_DIR" "$JJH_APP_NAME" ;;
            8) remove_system "$GB_FRONTEND_DOMAIN" "$GB_APP_DIR" "$GB_APP_NAME" "$GB_BACKEND_DOMAIN" ; remove_system "$JJH_DOMAIN" "$JJH_APP_DIR" "$JJH_APP_NAME" ;;
            9) echo "Saindo."; exit 0 ;;
            *) echo -e "${RED}Opção inválida. Tente novamente.${NC}" ;;
        esac
    done
}

# --- Script Entry Point ---
show_main_menu
exit 0