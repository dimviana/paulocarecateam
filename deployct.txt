#!/bin/bash
# ==============================================================================
#           Unified Deployment Manager for SAAS Applications
# ==============================================================================
#
# This script automates the installation, update, and removal of multiple
# applications on the same server, each with its own domains and ports.
# It uses Nginx to serve static frontend files and as a reverse proxy
# for the backend.
#
# SYSTEMS MANAGED:
#   1. Gerencia Boleto
#   2. Jiu-Jitsu Hub
#
# PRE-REQUISITES:
#   - A Linux VPS (tested on Debian/Ubuntu).
#   - The backend for each application must be started separately (e.g., with PM2).
#   - The database for each application must be configured manually.
#   - NOTE: This script clones repositories using public HTTPS URLs. This will
#     fail for private repositories as the script is non-interactive. For
#     private repos, use SSH keys and adjust the repository URLs accordingly.
#
# USAGE:
#   1. Place this script in any directory (e.g., /tmp/deploy.sh).
#   2. Grant execution permissions: chmod +x deploy.sh
#   3. Run the script: ./deploy.sh
#   4. Follow the interactive menu prompts.
#
# ==============================================================================

# --- Global Settings ---
# Color codes for output
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
RED='\033[0;31m'
NC='\033[0m' # No Color
ADMIN_EMAIL="androiddiviana@gmail.com" # Common email for Certbot registration

# ==============================================================================
#               <<< APPLICATION CONFIGURATIONS >>>
#     EDIT THE VARIABLES IN THE SECTIONS BELOW FOR EACH APPLICATION
# ==============================================================================

# --- Configurações: Gerencia Boleto ---
GB_APP_NAME="Gerencia Boleto"
GB_FRONTEND_DOMAIN="boleto.abildeveloper.com.br"
GB_BACKEND_DOMAIN="boletobk.abildeveloper.com.br"
GB_REPO_URL="https://github.com/dimviana/gerencia-boleto.git"
GB_APP_DIR="/home/abildeveloper-gerenciaboleto/htdocs/boleto.abildeveloper.com.br"
GB_BUILD_DIR="dist"
GB_BACKEND_PORT=3004  # Porta interna do backend (NÃO PODE CONFLITAR)
GB_FRONTEND_NGINX_PORT=80 # Porta do Nginx para o Frontend
GB_BACKEND_NGINX_PORT=82  # Porta do Nginx para o Backend
GB_PM2_PROCESS_NAME="gerencia-boleto-backend" # <-- !!! NOME DO PROCESSO PM2 DO BACKEND !!!

# --- Configurações: Jiu-Jitsu Hub ---
JJH_APP_NAME="Jiu-Jitsu Hub"
JJH_FRONTEND_DOMAIN="paulocarecateam.abildeveloper.com.br"
JJH_BACKEND_DOMAIN="paulocarecabk.abildeveloper.com.br"
JJH_REPO_URL="https://github.com/dimviana/paulocarecateam.git"
JJH_APP_DIR="/home/abildeveloper-paulocarecateam/htdocs/paulocarecateam.abildeveloper.com.br"
JJH_BUILD_DIR="dist"
JJH_BACKEND_PORT=3003
JJH_FRONTEND_NGINX_PORT=81 # Porta do Nginx para o Frontend
JJH_BACKEND_NGINX_PORT=83  # Porta do Nginx para o Backend
JJH_PM2_PROCESS_NAME="jiujitsu-hub-backend" # <-- !!! NOME DO PROCESSO PM2 DO BACKEND !!!

# ==============================================================================
#                     <<< CORE LOGIC FUNCTIONS >>>
#         (Generally, no need to edit below this line)
# ==============================================================================

# --- Helper Functions ---
check_command() {
    command -v $1 >/dev/null 2>&1
}

# --- Generic Functions ---

install_dependencies() {
    echo -e "\n${YELLOW}[ STEP 1/5 ] Verificando e instalando dependências do sistema...${NC}"
    
    if check_command nginx && check_command node && check_command pm2 && check_command certbot; then
        echo -e "${GREEN}-> Todas as dependências principais (Nginx, Node.js, PM2, Certbot) já estão instaladas.${NC}"
        return
    fi
    
    sudo apt-get update -y
    sudo apt-get install -y curl git software-properties-common

    if ! check_command node || [[ $(node -v | cut -d . -f 1) < "v18" ]]; then
        echo "-> Configurando o repositório do Node.js v18..."
        curl -fsSL https://deb.nodesource.com/setup_18.x | sudo -E bash -
    fi

    echo "-> Instalando Nginx, Node.js, Certbot..."
    sudo apt-get install -y nginx nodejs certbot python3-certbot-nginx
    if [ $? -ne 0 ]; then
        echo -e "${RED}ERRO: Falha ao instalar dependências. Tente executar 'sudo apt-get -f install' e rode o script novamente.${NC}"
        exit 1
    fi

    if ! check_command pm2; then
        echo "-> Instalando PM2 globalmente via npm..."
        sudo npm install -g pm2
    fi

    echo -e "${GREEN}-> Dependências instaladas com sucesso.${NC}"
}

setup_source_code() {
    local APP_DIR="$1"
    local REPO_URL="$2"
    echo -e "\n${YELLOW}[ STEP 2/5 ] Baixando o código fonte...${NC}"

    if [ -d "$APP_DIR/.git" ]; then
        echo -e "${YELLOW}AVISO: O repositório já existe em '$APP_DIR'. Pulando o clone.${NC}"
        return
    fi

    sudo mkdir -p "$(dirname "$APP_DIR")"
    sudo chown -R $(whoami):$(whoami) "$(dirname "$APP_DIR")"

    # Set GIT_TERMINAL_PROMPT=0 to prevent interactive prompts for credentials.
    GIT_TERMINAL_PROMPT=0 git clone "$REPO_URL" "$APP_DIR"
    if [ $? -ne 0 ]; then
        echo -e "${RED}ERRO: Falha ao clonar o repositório. Verifique se a URL está correta, se o repositório é público e se há conexão com a internet.${NC}"
        exit 1
    fi
    sudo chown -R $(whoami):$(whoami) "$APP_DIR"
    echo -e "${GREEN}-> Código fonte clonado para '$APP_DIR'.${NC}"

    if [ -f "$APP_DIR/env.txt" ]; then
        echo "-> Renomeando env.txt para .env..."
        mv "$APP_DIR/env.txt" "$APP_DIR/.env"
        echo -e "${YELLOW}AVISO: O arquivo .env foi criado. Edite-o com suas credenciais de produção.${NC}"
    fi
}

build_application() {
    local APP_DIR="$1"
    local BUILD_DIR="$2"
    echo -e "\n${YELLOW}[ STEP 3/5 ] Construindo a aplicação frontend...${NC}"
    cd "$APP_DIR" || { echo -e "${RED}ERRO: Diretório '$APP_DIR' não encontrado.${NC}"; exit 1; }
    
    echo "--> Instalando dependências npm..."
    npm install
    if [ $? -ne 0 ]; then
        echo -e "${RED}ERRO: 'npm install' falhou.${NC}"
        exit 1
    fi

    echo "--> Executando o build..."
    npm run build
    if [ $? -ne 0 ]; then
        echo -e "${RED}ERRO: 'npm run build' falhou.${NC}"
        exit 1
    fi
    echo -e "${GREEN}-> Build concluído. Arquivos gerados em '$APP_DIR/$BUILD_DIR'.${NC}"
}

configure_nginx_and_ssl() {
    local FRONTEND_DOMAIN="$1"
    local BACKEND_DOMAIN="$2"
    local FRONTEND_NGINX_PORT="$3"
    local BACKEND_NGINX_PORT="$4"
    local APP_DIR="$5"
    local BUILD_DIR="$6"
    local BACKEND_PORT="$7"
    
    echo -e "\n${YELLOW}[ STEP 4/5 ] Configurando Nginx e SSL...${NC}"
    NGINX_CONF_PATH="/etc/nginx/sites-available/$FRONTEND_DOMAIN"
    
    sudo tee "$NGINX_CONF_PATH" > /dev/null <<EOF
# Configuração do Frontend: $FRONTEND_DOMAIN
server {
    listen $FRONTEND_NGINX_PORT;
    server_name $FRONTEND_DOMAIN;

    root $APP_DIR/$BUILD_DIR;
    index index.html index.htm;

    location / {
        try_files \$uri \$uri/ /index.html;
    }
}

# Configuração do Backend: $BACKEND_DOMAIN
server {
    listen $BACKEND_NGINX_PORT;
    server_name $BACKEND_DOMAIN;

    location / {
        add_header 'Access-Control-Allow-Origin' 'https://$FRONTEND_DOMAIN' always;
        add_header 'Access-Control-Allow-Methods' 'GET, POST, PUT, DELETE, OPTIONS' always;
        add_header 'Access-Control-Allow-Headers' 'Origin, X-Requested-With, Content-Type, Accept, Authorization' always;
        add_header 'Access-Control-Allow-Credentials' 'true' always;

        if (\$request_method = 'OPTIONS') {
            return 204;
        }

        proxy_pass http://localhost:$BACKEND_PORT;
        proxy_set_header Host \$host;
        proxy_set_header X-Real-IP \$remote_addr;
        proxy_set_header X-Forwarded-For \$proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto \$scheme;
    }
}
EOF

    if [ ! -L "/etc/nginx/sites-enabled/$FRONTEND_DOMAIN" ]; then
        sudo ln -s "$NGINX_CONF_PATH" "/etc/nginx/sites-enabled/$FRONTEND_DOMAIN"
    fi

    sudo nginx -t && sudo systemctl restart nginx
    if [ $? -ne 0 ]; then
        echo -e "${RED}ERRO: Falha ao reiniciar o Nginx. As portas $FRONTEND_NGINX_PORT ou $BACKEND_NGINX_PORT podem estar em uso.${NC}"
        exit 1
    fi

    echo "-> Tentando gerar certificado SSL com Certbot..."
    sudo certbot --nginx -d "$FRONTEND_DOMAIN" -d "$BACKEND_DOMAIN" --non-interactive --agree-tos -m "$ADMIN_EMAIL"
    if [ $? -ne 0 ]; then
        echo -e "${YELLOW}AVISO: Falha ao gerar o certificado SSL. A aplicação estará disponível apenas em HTTP nas portas $FRONTEND_NGINX_PORT e $BACKEND_NGINX_PORT.${NC}"
    else
        echo -e "${GREEN}-> Certificado SSL gerado com sucesso.${NC}"
    fi
    
    sudo systemctl restart nginx
    echo -e "${GREEN}-> Nginx configurado.${NC}"
}

print_success_message() {
    local FRONTEND_DOMAIN="$1"
    local BACKEND_DOMAIN="$2"
    local BACKEND_PORT="$3"
    local PM2_PROCESS_NAME="$4"
    local APP_NAME="$5"

    echo -e "\n${GREEN}========================================================"
    echo "           INSTALAÇÃO DE '$APP_NAME' CONCLUÍDA!             "
    echo "========================================================${NC}"
    echo "Acesse o frontend em:   https://$FRONTEND_DOMAIN"
    echo "O backend está em:      https://$BACKEND_DOMAIN"
    echo ""
    echo -e "${YELLOW}------------------- PRÓXIMOS PASSOS --------------------${NC}"
    echo "1. Configure o banco de dados manualmente."
    echo "2. Edite o arquivo .env em seu diretório com as credenciais."
    echo "3. Inicie o servidor de backend na porta ${YELLOW}$BACKEND_PORT${NC}."
    echo "   Exemplo com PM2: ${YELLOW}pm2 start your-backend.js --name $PM2_PROCESS_NAME${NC}"
    echo "========================================================"
}

# --- Generic Workflow Functions ---

install_system() {
    local APP_NAME="$1"
    local FRONTEND_DOMAIN="$2"
    local BACKEND_DOMAIN="$3"
    local FRONTEND_NGINX_PORT="$4"
    local BACKEND_NGINX_PORT="$5"
    local APP_DIR="$6"
    local BUILD_DIR="$7"
    local BACKEND_PORT="$8"
    local REPO_URL="$9"
    local PM2_PROCESS_NAME="${10}"

    set -e
    echo -e "\n--- INICIANDO INSTALAÇÃO COMPLETA PARA: $APP_NAME ---"
    install_dependencies
    setup_source_code "$APP_DIR" "$REPO_URL"
    build_application "$APP_DIR" "$BUILD_DIR"
    configure_nginx_and_ssl "$FRONTEND_DOMAIN" "$BACKEND_DOMAIN" "$FRONTEND_NGINX_PORT" "$BACKEND_NGINX_PORT" "$APP_DIR" "$BUILD_DIR" "$BACKEND_PORT"
    print_success_message "$FRONTEND_DOMAIN" "$BACKEND_DOMAIN" "$BACKEND_PORT" "$PM2_PROCESS_NAME" "$APP_NAME"
    set +e
}

update_system() {
    local APP_DIR="$1"
    local BUILD_DIR="$2"
    local APP_NAME="$3"
    local PM2_PROCESS_NAME="$4"
    local REPO_URL="$5"

    set -e
    echo -e "\n--- INICIANDO ATUALIZAÇÃO PARA: $APP_NAME ---"
    if [ ! -d "$APP_DIR/.git" ]; then
        echo -e "${RED}ERRO: Diretório '$APP_DIR' não encontrado. Instale o sistema primeiro.${NC}"
        exit 1
    fi

    echo "-> Atualizando código fonte..."
    cd "$APP_DIR" || { echo -e "${RED}ERRO: Não foi possível acessar o diretório '$APP_DIR'.${NC}"; exit 1; }
    
    # Ensure remote URL matches the one in the config.
    CURRENT_URL=$(git config --get remote.origin.url)
    if [[ "$CURRENT_URL" != "$REPO_URL" ]]; then
        echo -e "${YELLOW}-> URL remota não corresponde à configuração. Atualizando para a URL pública.${NC}"
        git remote set-url origin "$REPO_URL"
    fi

    echo "--> Executando git pull..."
    # Set GIT_TERMINAL_PROMPT=0 to prevent interactive prompts for credentials.
    GIT_TERMINAL_PROMPT=0 git pull
    if [ $? -ne 0 ]; then
        echo -e "${RED}ERRO: Falha ao executar 'git pull'. Verifique se o repositório é público e se há conexão com a internet.${NC}"
        exit 1
    fi
    
    build_application "$APP_DIR" "$BUILD_DIR"
    
    echo -e "${GREEN}-> Frontend atualizado com sucesso!${NC}"
    echo -e "${YELLOW}AVISO: Se o backend foi atualizado, reinicie-o (ex: 'pm2 restart $PM2_PROCESS_NAME').${NC}"
    set +e
}

remove_system() {
    local FRONTEND_DOMAIN="$1"
    local APP_DIR="$2"
    local APP_NAME="$3"

    echo -e "\n--- INICIANDO REMOÇÃO DE: $APP_NAME ---"
    read -p "!!! ATENÇÃO !!! Isso removerá os arquivos e configs do Nginx para '$APP_NAME'. Deseja continuar? (s/N): " confirm
    if [[ "$confirm" != "s" && "$confirm" != "S" ]]; then
        echo "Remoção cancelada."
        return
    fi

    echo "-> Removendo certificado SSL (se existir)..."
    sudo certbot delete --cert-name "$FRONTEND_DOMAIN" --non-interactive 2>/dev/null || echo "Certificado não encontrado, pulando."
    
    echo "-> Removendo configurações do Nginx..."
    sudo rm -f "/etc/nginx/sites-available/$FRONTEND_DOMAIN"
    sudo rm -f "/etc/nginx/sites-enabled/$FRONTEND_DOMAIN"
    sudo nginx -t && sudo systemctl restart nginx

    echo "-> Removendo arquivos da aplicação..."
    sudo rm -rf "$APP_DIR"
    
    echo -e "${GREEN}--- REMOÇÃO COMPLETA DE '$APP_NAME' ---${NC}"
    echo -e "${YELLOW}AVISO: O banco de dados e o processo PM2 do backend NÃO foram removidos.${NC}"
}

# --- Combined Action Functions ---

install_both_systems() {
    echo -e "\n--- INICIANDO INSTALAÇÃO DE AMBOS OS SISTEMAS ---"
    echo -e "${YELLOW}A instalação será executada sequencialmente. Se ocorrer um erro, o script será interrompido.${NC}"
    
    install_system "$GB_APP_NAME" "$GB_FRONTEND_DOMAIN" "$GB_BACKEND_DOMAIN" "$GB_FRONTEND_NGINX_PORT" "$GB_BACKEND_NGINX_PORT" "$GB_APP_DIR" "$GB_BUILD_DIR" "$GB_BACKEND_PORT" "$GB_REPO_URL" "$GB_PM2_PROCESS_NAME"
    
    install_system "$JJH_APP_NAME" "$JJH_FRONTEND_DOMAIN" "$JJH_BACKEND_DOMAIN" "$JJH_FRONTEND_NGINX_PORT" "$JJH_BACKEND_NGINX_PORT" "$JJH_APP_DIR" "$JJH_BUILD_DIR" "$JJH_BACKEND_PORT" "$JJH_REPO_URL" "$JJH_PM2_PROCESS_NAME"

    echo -e "\n${GREEN}--- INSTALAÇÃO DE AMBOS OS SISTEMAS CONCLUÍDA COM SUCESSO ---${NC}"
}

remove_both_systems() {
    echo -e "\n--- INICIANDO REMOÇÃO DE AMBOS OS SISTEMAS ---"
    read -p "!!! ATENÇÃO !!! Você está prestes a remover AMBOS os sistemas. Será pedida uma confirmação para cada um. Deseja continuar? (s/N): " confirm
    if [[ "$confirm" != "s" && "$confirm" != "S" ]]; then
        echo "Remoção cancelada."
        return
    fi
    
    remove_system "$GB_FRONTEND_DOMAIN" "$GB_APP_DIR" "$GB_APP_NAME"
    remove_system "$JJH_FRONTEND_DOMAIN" "$JJH_APP_DIR" "$JJH_APP_NAME"

    echo -e "\n${GREEN}--- REMOÇÃO DE AMBOS OS SISTEMAS CONCLUÍDA ---${NC}"
}

# --- Main Menu ---

show_main_menu() {
    while true; do
        echo -e "\n================================================="
        echo -e "      ${GREEN}Gerenciador de Implantação Unificado${NC}"
        echo "================================================="
        echo "  1) Instalar Gerencia Boleto"
        echo "  2) Instalar Jiu-Jitsu Hub"
        echo "  3) Instalar AMBOS os sistemas"
        echo "  4) Remover AMBOS os sistemas"
        echo "  5) Atualizar Gerencia Boleto"
        echo "  6) Atualizar Jiu-Jitsu Hub"
        echo
        echo -e "${YELLOW}-- Outras Opções --${NC}"
        echo "  7) Remover Gerencia Boleto (Individual)"
        echo "  8) Remover Jiu-Jitsu Hub (Individual)"
        echo "  9) Sair"
        echo

        read -p "Opção [1-9]: " choice

        case $choice in
            1) install_system "$GB_APP_NAME" "$GB_FRONTEND_DOMAIN" "$GB_BACKEND_DOMAIN" "$GB_FRONTEND_NGINX_PORT" "$GB_BACKEND_NGINX_PORT" "$GB_APP_DIR" "$GB_BUILD_DIR" "$GB_BACKEND_PORT" "$GB_REPO_URL" "$GB_PM2_PROCESS_NAME" ;;
            2) install_system "$JJH_APP_NAME" "$JJH_FRONTEND_DOMAIN" "$JJH_BACKEND_DOMAIN" "$JJH_FRONTEND_NGINX_PORT" "$JJH_BACKEND_NGINX_PORT" "$JJH_APP_DIR" "$JJH_BUILD_DIR" "$JJH_BACKEND_PORT" "$JJH_REPO_URL" "$JJH_PM2_PROCESS_NAME" ;;
            3) install_both_systems ;;
            4) remove_both_systems ;;
            5) update_system "$GB_APP_DIR" "$GB_BUILD_DIR" "$GB_APP_NAME" "$GB_PM2_PROCESS_NAME" "$GB_REPO_URL" ;;
            6) update_system "$JJH_APP_DIR" "$JJH_BUILD_DIR" "$JJH_APP_NAME" "$JJH_PM2_PROCESS_NAME" "$JJH_REPO_URL" ;;
            7) remove_system "$GB_FRONTEND_DOMAIN" "$GB_APP_DIR" "$GB_APP_NAME" ;;
            8) remove_system "$JJH_FRONTEND_DOMAIN" "$JJH_APP_DIR" "$JJH_APP_NAME" ;;
            9) echo "Saindo."; exit 0 ;;
            *) echo -e "${RED}Opção inválida. Tente novamente.${NC}" ;;
        esac
    done
}

# --- Script Entry Point ---
show_main_menu
exit 0