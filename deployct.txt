#!/bin/bash
# ==============================================================================
# Script de Implantação para Jiu-Jitsu Hub SAAS (com SSL)
#
# Este script automatiza a configuração de um servidor para rodar a aplicação.
# Instala dependências, clona/atualiza o repositório, configura MySQL, Nginx,
# Certbot para SSL, e inicia a aplicação com PM2.
#
# USO:
# 1. Coloque este script em qualquer diretório no seu servidor (ex: /tmp).
# 2. Dê permissão de execução: chmod +x deployct.txt
# 3. Execute o script: ./deployct.txt
#
# O script irá criar o diretório de destino, clonar o repositório do GitHub
# e configurar todo o ambiente automaticamente.
# ==============================================================================

# --- Configurações do Banco de Dados ---
DBNAME="paulocarecateam"
DBUSER="paulocarecateam"
DBPASS="Fr35Aa4DkZ8KhEuq2asf"
DBHOST="localhost"
DB_SCHEMA_FILE="bancodedados.txt" # Nome do arquivo de schema dentro do repositório

# --- Configurações da Aplicação ---
APP_PORT="3001"
NGINX_HTTP_PORT="3002"
APP_DOMAIN="paulocarecateam.abildeveloper.com.br"
ADMIN_EMAIL="androiddiviana@gmail.com" # Email para registro do Certbot
APP_DIR="/home/abildeveloper-paulocarecateam/htdocs/paulocarecateam.abildeveloper.com.br"
REPO_URL="https://github.com/dimviana/paulocarecateam.git"

# --- Funções Auxiliares ---
check_command() {
    command -v $1 >/dev/null 2>&1
}

echo "================================================="
echo " INICIANDO A IMPLANTAÇÃO DO JIU-JITSU HUB SAAS (COM SSL) "
echo "================================================="

# 1. ATUALIZAR O SISTEMA E INSTALAR DEPENDÊNCIAS
# ------------------------------------------------------------------------------
echo -e "\n[ ETAPA 1/9 ] Atualizando o sistema e instalando dependências..."
sudo apt-get update -y
sudo apt-get install -y mysql-server nginx nodejs npm certbot python3-certbot-nginx git

# Verificar se Node.js precisa ser de uma versão específica
if ! check_command node || [[ $(node -v | cut -d . -f 1) < "v18" ]]; then
    echo "-> Instalando Node.js v18..."
    curl -fsSL https://deb.nodesource.com/setup_18.x | sudo -E bash -
    sudo apt-get install -y nodejs
else
    echo "-> Node.js já está instalado e na versão correta."
fi

# 2. PREPARAR DIRETÓRIO E CÓDIGO FONTE
# ------------------------------------------------------------------------------
echo -e "\n[ ETAPA 2/9 ] Preparando o diretório e baixando o código fonte..."
# Garante que o diretório pai existe e tem as permissões corretas
sudo mkdir -p "$(dirname "$APP_DIR")"
sudo chown -R $(whoami):$(whoami) "$(dirname "$APP_DIR")"

# Verifica se o diretório da aplicação já é um repositório git
if [ -d "$APP_DIR/.git" ]; then
    echo "-> Repositório encontrado em '$APP_DIR'. Atualizando..."
    cd "$APP_DIR"
    git pull origin main
    if [ $? -ne 0 ]; then
        echo "-> ERRO: Falha ao atualizar o repositório. Verifique as permissões ou conflitos e tente novamente."
        exit 1
    fi
else
    echo "-> Diretório '$APP_DIR' não é um repositório. Clonando..."
    # Remove o diretório se existir, para garantir um clone limpo
    if [ -d "$APP_DIR" ]; then
        echo "-> Removendo diretório existente para um clone limpo."
        sudo rm -rf "$APP_DIR"
    fi
    git clone "$REPO_URL" "$APP_DIR"
    if [ $? -ne 0 ]; then
        echo "-> ERRO: Falha ao clonar o repositório."
        exit 1
    fi
    echo "-> Repositório clonado com sucesso."
fi

sudo chown -R $(whoami):$(whoami) "$APP_DIR"
echo "-> Código fonte está pronto."

# 3. CONFIGURAR O BANCO DE DADOS MYSQL
# ------------------------------------------------------------------------------
echo -e "\n[ ETAPA 3/9 ] Configurando o Banco de Dados MySQL..."
sudo mysql -u root <<EOF
CREATE DATABASE IF NOT EXISTS $DBNAME;
CREATE USER IF NOT EXISTS '$DBUSER'@'$DBHOST' IDENTIFIED BY '$DBPASS';
GRANT ALL PRIVILEGES ON $DBNAME.* TO '$DBUSER'@'$DBHOST';
FLUSH PRIVILEGES;
EOF
echo "-> Banco de dados e usuário configurados."

# 4. IMPORTAR O ESQUEMA DO BANCO DE DADOS
# ------------------------------------------------------------------------------
echo -e "\n[ ETAPA 4/9 ] Importando o esquema do banco de dados..."
SCHEMA_PATH="$APP_DIR/$DB_SCHEMA_FILE"
if [ -f "$SCHEMA_PATH" ]; then
    sudo mysql -u root $DBNAME < "$SCHEMA_PATH"
    echo "-> Esquema do banco de dados importado com sucesso."
else
    echo "-> AVISO: Arquivo '$SCHEMA_PATH' não encontrado. O banco de dados permanecerá vazio."
fi

# 5. INSTALAR GERENCIADOR DE PROCESSO E SERVIDOR WEB
# ------------------------------------------------------------------------------
echo -e "\n[ ETAPA 5/9 ] Instalando PM2 e Serve via npm..."
if ! check_command pm2; then sudo npm install -g pm2; fi
if ! check_command serve; then sudo npm install -g serve; fi
echo "-> PM2 e Serve estão instalados."

# 6. CONFIGURAR O NGINX (INICIALMENTE EM HTTP PARA VALIDAÇÃO)
# ------------------------------------------------------------------------------
echo -e "\n[ ETAPA 6/9 ] Configurando o Nginx para validação SSL..."
NGINX_CONF_PATH="/etc/nginx/sites-available/$APP_DOMAIN"

#
# !!! AVISO IMPORTANTE !!!
# O Certbot precisa que a porta 80 esteja temporariamente livre para este domínio
# para validar o certificado. Se outro serviço estiver bloqueando a porta 80
# globalmente, esta etapa PODE FALHAR.
#
echo "-> AVISO: A porta 80 deve estar disponível para o domínio $APP_DOMAIN para a validação do certificado SSL."

sudo tee $NGINX_CONF_PATH > /dev/null <<EOF
server {
    listen 80;
    server_name $APP_DOMAIN;

    location / {
        proxy_pass http://localhost:$APP_PORT;
        proxy_set_header Host \$host;
        proxy_set_header X-Real-IP \$remote_addr;
        proxy_set_header X-Forwarded-For \$proxy_add_x_forwarded_for;
    }
}
EOF

if [ ! -L "/etc/nginx/sites-enabled/$APP_DOMAIN" ]; then
    sudo ln -s $NGINX_CONF_PATH /etc/nginx/sites-enabled/
fi

sudo nginx -t && sudo systemctl restart nginx
if [ $? -ne 0 ]; then
    echo "-> ERRO: Falha ao iniciar o Nginx. A porta 80 pode estar em uso. Verifique e tente novamente."
    exit 1
fi

# 7. GERAR CERTIFICADO SSL COM CERTBOT
# ------------------------------------------------------------------------------
echo -e "\n[ ETAPA 7/9 ] Gerando certificado SSL com Certbot..."
sudo certbot --nginx -d $APP_DOMAIN --non-interactive --agree-tos -m $ADMIN_EMAIL --redirect
if [ $? -ne 0 ]; then
    echo "-> ERRO: Falha ao gerar o certificado SSL. Verifique se o DNS para $APP_DOMAIN está correto e se a porta 80 está acessível."
    exit 1
fi
echo "-> Certificado SSL gerado e Nginx configurado para HTTPS."

# 8. CONFIGURAR REDIRECIONAMENTO DE PORTA HTTP ADICIONAL
# ------------------------------------------------------------------------------
echo -e "\n[ ETAPA 8/9 ] Configurando redirecionamento da porta $NGINX_HTTP_PORT para HTTPS..."
sudo tee -a $NGINX_CONF_PATH > /dev/null <<EOF

server {
    listen $NGINX_HTTP_PORT;
    server_name $APP_DOMAIN;
    return 301 https://\$host\$request_uri;
}
EOF

sudo nginx -t && sudo systemctl restart nginx
echo "-> Nginx reiniciado com todas as configurações."


# 9. INICIAR A APLICAÇÃO COM PM2
# ------------------------------------------------------------------------------
echo -e "\n[ ETAPA 9/9 ] Iniciando a aplicação com PM2..."
APP_COMMAND="serve -s . -l $APP_PORT"
pm2 stop "$DBNAME" 2>/dev/null || true
pm2 delete "$DBNAME" 2>/dev/null || true
cd $APP_DIR && pm2 start "$APP_COMMAND" --name "$DBNAME"
pm2 startup | sudo bash -
pm2 save

echo "========================================="
echo "        IMPLANTAÇÃO CONCLUÍDA!         "
echo "========================================="
echo "Acesse a aplicação de forma segura em: https://$APP_DOMAIN"
echo "(O acesso por http://$APP_DOMAIN:$NGINX_HTTP_PORT será redirecionado automaticamente)"
echo "-----------------------------------------"
echo "Para gerenciar a aplicação, use os comandos PM2:"
echo "  - Ver logs:       pm2 logs $DBNAME"
echo "  - Parar:          pm2 stop $DBNAME"
echo "  - Reiniciar:      pm2 restart $DBNAME"
echo "  - Status:         pm2 status"
echo "========================================="
