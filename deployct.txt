#!/bin/bash
# ==============================================================================
# Script de Gerenciamento de Implantação para Jiu-Jitsu Hub SAAS
#
# Este script automatiza a instalação, atualização e remoção da aplicação,
# utilizando Nginx para servir os arquivos estáticos do frontend e como
# proxy reverso para o backend em domínios separados.
#
# IMPORTANTE: A configuração do banco de dados MySQL é MANUAL.
# O servidor de backend DEVE ser iniciado separadamente (ex: com PM2).
#
# USO:
# 1. Coloque este script em qualquer diretório no seu servidor (ex: /tmp).
# 2. Dê permissão de execução: chmod +x deployct.txt
# 3. Execute o script: ./deployct.txt
# 4. Escolha uma das opções no menu interativo.
#
# OPÇÕES:
# 1. Instalar Sistema: Realiza a configuração completa do zero.
# 2. Atualizar Sistema: Baixa a versão mais recente do código e o reconstrói.
# 3. Remover Sistema: Apaga a aplicação e configurações (NÃO apaga o banco).
# ==============================================================================

# --- Configurações da Aplicação ---
FRONTEND_DOMAIN="paulocarecateam.abildeveloper.com.br"
BACKEND_DOMAIN="paulocarecabk.abildeveloper.com.br"
ADMIN_EMAIL="androiddiviana@gmail.com" # Email para registro do Certbot
APP_DIR="/home/abildeveloper-paulocarecateam/htdocs/paulocarecateam.abildeveloper.com.br"
REPO_URL="https://github.com/dimviana/paulocarecateam.git"
BUILD_DIR="dist" # Diretório de build do React (geralmente 'build' ou 'dist' para Vite)
BACKEND_PORT=3002 # Porta interna do backend (DEVE ser iniciada separadamente)
NGINX_PORT=80    # Porta padrão para HTTP, necessária para Certbot

# --- Funções Auxiliares ---
check_command() {
    command -v $1 >/dev/null 2>&1
}

# --- Funções de Lógica ---

install_dependencies() {
    echo -e "\n[ ETAPA 1/4 ] Atualizando o sistema e instalando dependências..."
    sudo apt-get update -y
    # Instala pré-requisitos para adicionar repositórios e para o script
    sudo apt-get install -y curl git software-properties-common

    # Configura o repositório do Node.js v18 ANTES de tentar instalar
    if ! check_command node || [[ $(node -v | cut -d . -f 1) < "v18" ]]; then
        echo "-> Configurando o repositório do Node.js v18..."
        curl -fsSL https://deb.nodesource.com/setup_18.x | sudo -E bash -
    else
        echo "-> Node.js já está instalado e na versão correta."
    fi

    echo "-> Instalando dependências (Nginx, Node.js, Certbot)..."
    sudo apt-get install -y nginx nodejs certbot python3-certbot-nginx

    if [ $? -ne 0 ]; then
        echo "-> A instalação inicial falhou. Tentando corrigir pacotes quebrados..."
        sudo apt-get --fix-broken install -y
        sudo apt-get install -y nginx nodejs certbot python3-certbot-nginx
        if [ $? -ne 0 ]; then
            echo "-> ERRO: Falha ao instalar dependências mesmo após tentar corrigir. Verifique os logs do apt."
            exit 1
        fi
    fi

    echo "-> Instalando PM2 globalmente via npm (para gerenciar o backend)..."
    sudo npm install -g pm2
    if [ $? -ne 0 ]; then
        echo "-> ERRO: Falha ao instalar PM2."
        exit 1
    fi
    echo "-> Dependências instaladas com sucesso."
}

setup_source_code() {
    echo -e "\n[ ETAPA 2/4 ] Preparando o diretório e baixando o código fonte..."
    if [ -d "$APP_DIR/.git" ]; then
        echo "-> AVISO: Repositório já existe. Se deseja uma instalação limpa, remova o sistema primeiro."
        return
    fi

    sudo mkdir -p "$(dirname "$APP_DIR")"
    sudo chown -R $(whoami):$(whoami) "$(dirname "$APP_DIR")"

    git clone "$REPO_URL" "$APP_DIR"
    if [ $? -ne 0 ]; then
        echo "-> ERRO: Falha ao clonar o repositório."
        exit 1
    fi
    sudo chown -R $(whoami):$(whoami) "$APP_DIR"
    echo "-> Código fonte clonado com sucesso."

    # Renomeia env.txt para .env se o arquivo existir
    if [ -f "$APP_DIR/env.txt" ]; then
        echo "-> Renomeando env.txt para .env..."
        mv "$APP_DIR/env.txt" "$APP_DIR/.env"
        echo "-> AVISO: O arquivo .env foi criado. Edite-o com suas credenciais de produção."
    else
        echo "-> AVISO: Arquivo env.txt não encontrado no repositório. Crie um arquivo .env manualmente se necessário."
    fi
}

build_application() {
    echo -e "\n[ ETAPA 3/4 ] Construindo a aplicação React..."
    cd "$APP_DIR"
    
    echo "--> Instalando dependências npm..."
    npm install
    if [ $? -ne 0 ]; then
        echo "-> ERRO: 'npm install' falhou."
        exit 1
    fi

    echo "--> Executando o build da aplicação..."
    npm run build
    if [ $? -ne 0 ]; then
        echo "-> ERRO: 'npm run build' falhou. Verifique se o script existe no package.json."
        exit 1
    fi
    echo "-> Build concluído. Arquivos gerados em '$APP_DIR/$BUILD_DIR'."
}

configure_nginx_and_ssl() {
    echo -e "\n[ ETAPA 4/4 ] Configurando Nginx para os domínios e gerando SSL..."
    NGINX_CONF_PATH="/etc/nginx/sites-available/$FRONTEND_DOMAIN"
    
    echo "-> AVISO: Esta configuração assume que um servidor de backend está rodando na porta $BACKEND_PORT."
    echo "-> Domínio do Backend ($BACKEND_DOMAIN) será redirecionado para o backend."

    # Cria uma única configuração Nginx para ambos os domínios.
    sudo tee $NGINX_CONF_PATH > /dev/null <<EOF
# Configuração do Frontend (Aplicação React)
server {
    listen $NGINX_PORT;
    server_name $FRONTEND_DOMAIN;

    root $APP_DIR/$BUILD_DIR;
    index index.html index.htm;

    # Serve a aplicação frontend React para todas as outras requisições
    location / {
        try_files \$uri \$uri/ /index.html;
    }
}

# Configuração do Backend (Proxy Reverso com CORS)
server {
    listen $NGINX_PORT;
    server_name $BACKEND_DOMAIN;

    location / {
        # Adiciona cabeçalhos CORS para permitir requisições do frontend
        # O 'always' garante que o header seja adicionado mesmo em respostas de erro
        add_header 'Access-Control-Allow-Origin' 'https://$FRONTEND_DOMAIN' always;
        add_header 'Access-Control-Allow-Methods' 'GET, POST, PUT, DELETE, OPTIONS' always;
        add_header 'Access-Control-Allow-Headers' 'Origin, X-Requested-With, Content-Type, Accept, Authorization' always;
        add_header 'Access-Control-Allow-Credentials' 'true' always;

        # Lida com a requisição de preflight OPTIONS do navegador
        if (\$request_method = 'OPTIONS') {
            # Responde com 204 No Content, que é o esperado para preflights
            return 204;
        }

        # Passa a requisição para o servidor backend
        proxy_pass http://localhost:$BACKEND_PORT;
        proxy_set_header Host \$host;
        proxy_set_header X-Real-IP \$remote_addr;
        proxy_set_header X-Forwarded-For \$proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto \$scheme;
    }
}
EOF

    if [ ! -L "/etc/nginx/sites-enabled/$FRONTEND_DOMAIN" ]; then
        sudo ln -s "$NGINX_CONF_PATH" "/etc/nginx/sites-enabled/$FRONTEND_DOMAIN"
    fi

    sudo nginx -t && sudo systemctl restart nginx
    if [ $? -ne 0 ]; then
        echo "-> ERRO: Falha ao iniciar o Nginx. A porta $NGINX_PORT pode estar em uso."
        exit 1
    fi

    echo "-> Tentando gerar certificado SSL com Certbot para ambos os domínios..."
    sudo certbot --nginx -d "$FRONTEND_DOMAIN" -d "$BACKEND_DOMAIN" --non-interactive --agree-tos -m "$ADMIN_EMAIL"
    if [ $? -ne 0 ]; then
        echo "-> AVISO: Falha ao gerar o certificado SSL. A aplicação estará disponível apenas em HTTP."
    else
        echo "-> Certificado SSL gerado e configurado com sucesso para ambos os domínios."
    fi
    
    sudo systemctl restart nginx
    echo "-> Nginx configurado."
}

print_success_message() {
    echo "========================================================"
    echo "                OPERAÇÃO CONCLUÍDA!                     "
    echo "========================================================"
    echo "Acesse o frontend em: https://$FRONTEND_DOMAIN"
    echo "O backend está disponível em: https://$BACKEND_DOMAIN"
    echo "--------------------------------------------------------"
    echo "O frontend está sendo servido diretamente pelo Nginx."
    echo "Para atualizar, basta rodar a opção 'Atualizar Sistema'."
    echo "--------------------------------------------------------"
    echo "IMPORTANTE: Lembre-se de configurar o banco de dados manualmente"
    echo "e de iniciar o servidor de backend na porta $BACKEND_PORT (ex: com 'pm2 start your-backend-script.js')."
    echo "========================================================"
}

# --- Funções do Menu ---

install_system() {
    set -e # Encerra o script se algum comando falhar
    echo "--- INICIANDO INSTALAÇÃO COMPLETA ---"
    install_dependencies
    setup_source_code
    build_application
    configure_nginx_and_ssl
    print_success_message
}

update_system() {
    set -e
    echo "--- INICIANDO ATUALIZAÇÃO DO SISTEMA ---"
    if [ ! -d "$APP_DIR/.git" ]; then
        echo "ERRO: Diretório de instalação não encontrado em '$APP_DIR'. Execute a instalação primeiro."
        exit 1
    fi

    echo "-> Atualizando código fonte via git pull..."
    cd "$APP_DIR"
    git pull origin main
    echo "-> Código fonte atualizado."
    
    build_application
    
    echo "-> Frontend atualizado. Nginx servirá os novos arquivos automaticamente."
    echo "-> AVISO: Se você atualizou o backend, lembre-se de reiniciá-lo (ex: 'pm2 restart backend-app-name')."
    
    echo "--- ATUALIZAÇÃO CONCLUÍDA ---"
}

remove_system() {
    echo "--- INICIANDO REMOÇÃO DO SISTEMA ---"
    read -p "!!! ATENÇÃO !!! Isso removerá a aplicação e as configurações do servidor web. Deseja continuar? (s/N): " confirm
    if [[ "$confirm" != "s" && "$confirm" != "S" ]]; then
        echo "Remoção cancelada."
        exit 0
    fi

    echo "-> Removendo processo PM2 (se existir)..."
    pm2 stop "$FRONTEND_DOMAIN" 2>/dev/null || true
    pm2 delete "$FRONTEND_DOMAIN" 2>/dev/null || true
    pm2 save --force
    
    echo "-> Removendo certificado SSL (se existir)..."
    sudo certbot delete --cert-name "$FRONTEND_DOMAIN" --non-interactive
    
    echo "-> Removendo configurações do Nginx..."
    sudo rm -f "/etc/nginx/sites-available/$FRONTEND_DOMAIN"
    sudo rm -f "/etc/nginx/sites-enabled/$FRONTEND_DOMAIN"
    sudo nginx -t && sudo systemctl restart nginx

    echo "-> Removendo arquivos da aplicação..."
    sudo rm -rf "$APP_DIR"
    
    echo "--- REMOÇÃO COMPLETA ---"
    echo "AVISO: O banco de dados NÃO foi removido. Você deve removê-lo manualmente se necessário."
    echo "AVISO: O processo do backend (se gerenciado por PM2) NÃO foi removido."
    echo "AVISO: Dependências como Nginx e Node.js não foram removidas."
}

# --- Menu Principal ---

echo "================================================="
echo "  Gerenciador de Implantação Jiu-Jitsu Hub SAAS"
echo "================================================="
echo "Escolha uma opção:"
echo "  1) Instalar Sistema (Configuração completa)"
echo "  2) Atualizar Sistema (Baixa a versão mais recente)"
echo "  3) Remover Sistema (Apaga a aplicação)"
echo

read -p "Opção [1, 2, 3]: " choice

case $choice in
    1)
        install_system
        ;;
    2)
        update_system
        ;;
    3)
        remove_system
        ;;
    *)
        echo "Opção inválida. Saindo."
        exit 1
        ;;
esac

exit 0