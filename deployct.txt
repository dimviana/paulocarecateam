#!/bin/bash
# ==============================================================================
# Script de Gerenciamento de Implantação para Jiu-Jitsu Hub SAAS
#
# Este script automatiza a instalação, atualização e remoção da aplicação,
# utilizando Nginx como proxy reverso e PM2 para gerenciar o processo da app.
#
# IMPORTANTE: A configuração do banco de dados MySQL é MANUAL.
# Você deve criar o banco, o usuário e conceder as permissões antes da instalação.
#
# USO:
# 1. Coloque este script em qualquer diretório no seu servidor (ex: /tmp).
# 2. Dê permissão de execução: chmod +x deployct.txt
# 3. Execute o script: ./deployct.txt
# 4. Escolha uma das opções no menu interativo.
#
# OPÇÕES:
# 1. Instalar Sistema: Realiza a configuração completa do zero.
# 2. Atualizar Sistema: Baixa a versão mais recente do código e reinicia a app.
# 3. Remover Sistema: Apaga a aplicação e configurações (NÃO apaga o banco).
# ==============================================================================

# --- Configurações da Aplicação ---
APP_DOMAIN="paulocarecateam.abildeveloper.com.br"
ADMIN_EMAIL="androiddiviana@gmail.com" # Email para registro do Certbot
APP_DIR="/home/abildeveloper-paulocarecateam/htdocs/paulocarecateam.abildeveloper.com.br"
REPO_URL="https://github.com/dimviana/paulocarecateam.git"
BUILD_DIR="dist" # Diretório de build do React (geralmente 'build' ou 'dist' para Vite)
APP_PORT=5000    # Porta interna do frontend (servido pelo PM2)
BACKEND_PORT=3002 # Porta interna do backend (DEVE ser iniciada separadamente)
NGINX_PORT=81    # Porta em que o Nginx irá escutar

# --- Funções Auxiliares ---
check_command() {
    command -v $1 >/dev/null 2>&1
}

# --- Funções de Lógica ---

install_dependencies() {
    echo -e "\n[ ETAPA 1/5 ] Atualizando o sistema e instalando dependências..."
    sudo apt-get update -y
    # Instala pré-requisitos para adicionar repositórios e para o script
    sudo apt-get install -y curl git software-properties-common

    # Configura o repositório do Node.js v18 ANTES de tentar instalar
    if ! check_command node || [[ $(node -v | cut -d . -f 1) < "v18" ]]; then
        echo "-> Configurando o repositório do Node.js v18..."
        curl -fsSL https://deb.nodesource.com/setup_18.x | sudo -E bash -
    else
        echo "-> Node.js já está instalado e na versão correta."
    fi

    echo "-> Instalando dependências (Nginx, Node.js, Certbot)..."
    sudo apt-get install -y nginx nodejs certbot python3-certbot-nginx

    if [ $? -ne 0 ]; then
        echo "-> A instalação inicial falhou. Tentando corrigir pacotes quebrados..."
        sudo apt-get --fix-broken install -y
        sudo apt-get install -y nginx nodejs certbot python3-certbot-nginx
        if [ $? -ne 0 ]; then
            echo "-> ERRO: Falha ao instalar dependências mesmo após tentar corrigir. Verifique os logs do apt."
            exit 1
        fi
    fi

    echo "-> Instalando PM2 e serve globalmente via npm..."
    sudo npm install -g pm2 serve
    if [ $? -ne 0 ]; then
        echo "-> ERRO: Falha ao instalar PM2 e serve."
        exit 1
    fi
    echo "-> Dependências instaladas com sucesso."
}

setup_source_code() {
    echo -e "\n[ ETAPA 2/5 ] Preparando o diretório e baixando o código fonte..."
    if [ -d "$APP_DIR/.git" ]; then
        echo "-> AVISO: Repositório já existe. Se deseja uma instalação limpa, remova o sistema primeiro."
        return
    fi

    sudo mkdir -p "$(dirname "$APP_DIR")"
    sudo chown -R $(whoami):$(whoami) "$(dirname "$APP_DIR")"

    git clone "$REPO_URL" "$APP_DIR"
    if [ $? -ne 0 ]; then
        echo "-> ERRO: Falha ao clonar o repositório."
        exit 1
    fi
    sudo chown -R $(whoami):$(whoami) "$APP_DIR"
    echo "-> Código fonte clonado com sucesso."

    # Renomeia env.txt para .env se o arquivo existir
    if [ -f "$APP_DIR/env.txt" ]; then
        echo "-> Renomeando env.txt para .env..."
        mv "$APP_DIR/env.txt" "$APP_DIR/.env"
        echo "-> AVISO: O arquivo .env foi criado. Edite-o com suas credenciais de produção."
    else
        echo "-> AVISO: Arquivo env.txt não encontrado no repositório. Crie um arquivo .env manualmente se necessário."
    fi
}

build_application() {
    echo -e "\n[ ETAPA 3/5 ] Construindo a aplicação React..."
    cd "$APP_DIR"
    
    echo "--> Instalando dependências npm..."
    npm install
    if [ $? -ne 0 ]; then
        echo "-> ERRO: 'npm install' falhou."
        exit 1
    fi

    echo "--> Executando o build da aplicação..."
    npm run build
    if [ $? -ne 0 ]; then
        echo "-> ERRO: 'npm run build' falhou. Verifique se o script existe no package.json."
        exit 1
    fi
    echo "-> Build concluído. Arquivos gerados em '$APP_DIR/$BUILD_DIR'."
}

configure_nginx_and_ssl() {
    echo -e "\n[ ETAPA 4/5 ] Configurando Nginx para a porta $NGINX_PORT e tentando gerar SSL..."
    NGINX_CONF_PATH="/etc/nginx/sites-available/$APP_DOMAIN"
    
    echo "-> AVISO: Esta configuração assume que um servidor de backend está rodando na porta $BACKEND_PORT."
    echo "-> As requisições para '/api/' serão redirecionadas para o backend."

    sudo tee $NGINX_CONF_PATH > /dev/null <<EOF
server {
    listen $NGINX_PORT;
    server_name $APP_DOMAIN;

    # Roteia requisições para a API de backend
    location /api/ {
        proxy_pass http://localhost:$BACKEND_PORT;
        proxy_set_header Host \$host;
        proxy_set_header X-Real-IP \$remote_addr;
        proxy_set_header X-Forwarded-For \$proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto \$scheme;
    }

    # Serve a aplicação frontend React para todas as outras requisições
    location / {
        proxy_pass http://localhost:$APP_PORT;
        proxy_http_version 1.1;
        proxy_set_header Upgrade \$http_upgrade;
        proxy_set_header Connection 'upgrade';
        proxy_set_header Host \$host;
        proxy_set_header X-Real-IP \$remote_addr;
        proxy_set_header X-Forwarded-For \$proxy_add_x_forwarded_for;
        proxy_cache_bypass \$http_upgrade;
    }
}
EOF

    if [ ! -L "/etc/nginx/sites-enabled/$APP_DOMAIN" ]; then
        sudo ln -s $NGINX_CONF_PATH /etc/nginx/sites-enabled/
    fi

    sudo nginx -t && sudo systemctl restart nginx
    if [ $? -ne 0 ]; then
        echo "-> ERRO: Falha ao iniciar o Nginx. A porta $NGINX_PORT pode estar em uso."
        exit 1
    fi

    echo "-> AVISO: A geração de certificado SSL pode falhar, pois o Certbot precisa validar o domínio na porta 80."
    echo "-> Tentando gerar certificado SSL com Certbot..."
    sudo certbot --nginx -d $APP_DOMAIN --non-interactive --agree-tos -m $ADMIN_EMAIL
    if [ $? -ne 0 ]; then
        echo "-> AVISO: Falha ao gerar o certificado SSL como esperado. A aplicação estará disponível apenas em HTTP na porta $NGINX_PORT."
    else
        echo "-> Certificado SSL gerado. No entanto, o Nginx está configurado para a porta $NGINX_PORT, então HTTPS pode não funcionar como esperado sem configuração manual adicional."
    fi
    
    sudo systemctl restart nginx
    echo "-> Nginx configurado."
}

start_application() {
    echo -e "\n[ ETAPA 5/5 ] Iniciando a aplicação com PM2..."
    cd "$APP_DIR"

    # Garante que qualquer processo antigo seja removido
    pm2 stop "$APP_DOMAIN" 2>/dev/null || true
    pm2 delete "$APP_DOMAIN" 2>/dev/null || true

    # Inicia o servidor estático 'serve' com PM2
    # -s: single-page app
    # -l: listen on port
    pm2 start serve --name "$APP_DOMAIN" -- -s "$BUILD_DIR" -l "$APP_PORT"

    # Configura PM2 para iniciar no boot do sistema
    pm2 startup | sudo bash -
    pm2 save --force
    echo "-> Aplicação iniciada com PM2 e configurada para iniciar no boot."
}

print_success_message() {
    echo "========================================================"
    echo "                OPERAÇÃO CONCLUÍDA!                     "
    echo "========================================================"
    echo "Acesse a aplicação em: http://$APP_DOMAIN:$NGINX_PORT"
    echo "AVISO: SSL provavelmente não foi ativado, pois o Nginx não está na porta 80."
    echo "--------------------------------------------------------"
    echo "A aplicação está sendo gerenciada pelo PM2."
    echo "Para ver os logs, use: pm2 logs $APP_DOMAIN"
    echo "Para reiniciar a app, use: pm2 restart $APP_DOMAIN"
    echo "--------------------------------------------------------"
    echo "IMPORTANTE: Lembre-se de configurar o banco de dados manualmente"
    echo "e de iniciar o servidor de backend na porta $BACKEND_PORT."
    echo "========================================================"
}

# --- Funções do Menu ---

install_system() {
    set -e # Encerra o script se algum comando falhar
    echo "--- INICIANDO INSTALAÇÃO COMPLETA ---"
    install_dependencies
    setup_source_code
    build_application
    configure_nginx_and_ssl
    start_application
    print_success_message
}

update_system() {
    set -e
    echo "--- INICIANDO ATUALIZAÇÃO DO SISTEMA ---"
    if [ ! -d "$APP_DIR/.git" ]; then
        echo "ERRO: Diretório de instalação não encontrado em '$APP_DIR'. Execute a instalação primeiro."
        exit 1
    fi

    echo "-> Atualizando código fonte via git pull..."
    cd "$APP_DIR"
    git pull origin main
    echo "-> Código fonte atualizado."
    
    build_application
    
    echo "-> Reiniciando a aplicação com PM2..."
    cd "$APP_DIR"
    # Garante que qualquer processo antigo seja removido antes de iniciar um novo para evitar o erro "process not found"
    pm2 stop "$APP_DOMAIN" 2>/dev/null || true
    pm2 delete "$APP_DOMAIN" 2>/dev/null || true
    pm2 start serve --name "$APP_DOMAIN" -- -s "$BUILD_DIR" -l "$APP_PORT"
    pm2 save --force
    
    echo "--- ATUALIZAÇÃO CONCLUÍDA ---"
}

remove_system() {
    echo "--- INICIANDO REMOÇÃO DO SISTEMA ---"
    read -p "!!! ATENÇÃO !!! Isso removerá a aplicação e as configurações do servidor web. Deseja continuar? (s/N): " confirm
    if [[ "$confirm" != "s" && "$confirm" != "S" ]]; then
        echo "Remoção cancelada."
        exit 0
    fi

    echo "-> Removendo aplicação do PM2..."
    pm2 stop "$APP_DOMAIN" 2>/dev/null || true
    pm2 delete "$APP_DOMAIN" 2>/dev/null || true
    pm2 save --force
    
    echo "-> Removendo script de inicialização do PM2..."
    pm2 unstartup | sudo bash -
    
    echo "-> Removendo certificado SSL (se existir)..."
    sudo certbot delete --cert-name "$APP_DOMAIN" --non-interactive
    
    echo "-> Removendo configurações do Nginx..."
    sudo rm -f "/etc/nginx/sites-available/$APP_DOMAIN"
    sudo rm -f "/etc/nginx/sites-enabled/$APP_DOMAIN"
    sudo nginx -t && sudo systemctl restart nginx

    echo "-> Removendo arquivos da aplicação..."
    sudo rm -rf "$APP_DIR"
    
    echo "--- REMOÇÃO COMPLETA ---"
    echo "AVISO: O banco de dados NÃO foi removido. Você deve removê-lo manualmente se necessário."
    echo "AVISO: Dependências como Nginx e Node.js não foram removidas."
}

# --- Menu Principal ---

echo "================================================="
echo "  Gerenciador de Implantação Jiu-Jitsu Hub SAAS"
echo "================================================="
echo "Escolha uma opção:"
echo "  1) Instalar Sistema (Configuração completa)"
echo "  2) Atualizar Sistema (Baixa a versão mais recente)"
echo "  3) Remover Sistema (Apaga a aplicação)"
echo

read -p "Opção [1, 2, 3]: " choice

case $choice in
    1)
        install_system
        ;;
    2)
        update_system
        ;;
    3)
        remove_system
        ;;
    *)
        echo "Opção inválida. Saindo."
        exit 1
        ;;
esac

exit 0
